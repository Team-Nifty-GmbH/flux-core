window.webPush=(function(){async function a(e){try{if(!("serviceWorker"in navigator)||!("PushManager"in window))return!1;const r=await navigator.serviceWorker.getRegistration();if(!r)return!1;const i=await r.pushManager.getSubscription();return i?i.endpoint===e:!1}catch(r){return console.error("Error checking current subscription:",r),!1}}async function s(){const e={serviceWorker:"serviceWorker"in navigator,pushManager:"PushManager"in window,notification:"Notification"in window,https:window.location.protocol==="https:"||window.location.hostname==="localhost"||window.location.hostname==="127.0.0.1",currentBrowserSubscribed:!1};if(e.allSupported=e.serviceWorker&&e.pushManager&&e.notification&&e.https,e.serviceWorker&&e.pushManager)try{const r=await navigator.serviceWorker.getRegistration();if(r){const i=await r.pushManager.getSubscription();e.currentBrowserSubscribed=i!==null}}catch(r){console.log("Could not check subscription status:",r)}return e}async function c(e=!1){const r=await s();if(!r.https){const t="Web Push requires HTTPS connection (or localhost)";return window.Livewire&&window.Livewire.dispatch("push-error",{message:t}),Promise.reject(t)}if(!r.serviceWorker){const t="Service Workers are not supported in this browser";return window.Livewire&&window.Livewire.dispatch("push-error",{message:t}),Promise.reject(t)}if(!r.pushManager){const t="Push notifications are not supported in this browser";return window.Livewire&&window.Livewire.dispatch("push-error",{message:t}),Promise.reject(t)}if(!r.notification){const t="Notifications are not supported in this browser";return window.Livewire&&window.Livewire.dispatch("push-error",{message:t}),Promise.reject(t)}let i=await navigator.serviceWorker.getRegistration();if(i)i.update().catch(t=>{console.log("Service worker update check failed:",t)});else{let t="/pwa-service-worker";try{i=await navigator.serviceWorker.register(t)}catch(n){throw console.error("Service Worker registration failed:",n),window.Livewire&&window.Livewire.dispatch("push-error",{message:"Failed to register Service Worker. Please check your browser settings."}),n}}const o=await i.pushManager.getSubscription();if(o&&!e)return window.Livewire&&window.Livewire.dispatch("push-subscription-updated"),o;if(o&&e)try{await o.unsubscribe()}catch(t){console.error("Error unsubscribing:",t)}return u()}async function u(){return await navigator.serviceWorker.ready,new Promise(function(e,r){const i=Notification.requestPermission(function(o){e(o)});i&&i.then(e,r)}).then(e=>{if(e==="denied"){const r="Notification permission was denied. Please enable notifications in your browser settings.";return window.Livewire&&window.Livewire.dispatch("push-error",{message:r}),Promise.reject(r)}if(e!=="granted"){const r="Notification permission was not granted";return window.Livewire&&window.Livewire.dispatch("push-error",{message:r}),Promise.reject(r)}return w()})}function w(){return navigator.serviceWorker.ready.then(e=>{const r={userVisibleOnly:!0,applicationServerKey:h(document.head.querySelector('meta[name="webpush-key"]').content)};return e.pushManager.subscribe(r)}).then(e=>p(e)).catch(e=>{throw console.error("Failed to subscribe the user: ",e),window.Livewire&&window.Livewire.dispatch("push-error",{message:"Failed to subscribe to push notifications. Please try again."}),e})}function p(e){const r=document.querySelector("meta[name=csrf-token]").getAttribute("content");return fetch("/push-subscription",{method:"POST",body:JSON.stringify(e),headers:{Accept:"application/json","Content-Type":"application/json","X-CSRF-Token":r}}).then(i=>i.json()).then(i=>(window.Livewire&&window.Livewire.dispatch("push-subscription-updated"),i)).catch(i=>{throw console.error("Failed to store push subscription:",i),i})}function h(e){let r="=".repeat((4-e.length%4)%4),i=(e+r).replace(/-/g,"+").replace(/_/g,"/"),o=window.atob(i),t=new Uint8Array(o.length);for(let n=0;n<o.length;++n)t[n]=o.charCodeAt(n);return t}return{checkCurrentSubscription:a,checkWebPushSupport:s,initSW:c}})();
